{{ 'output.css' | asset_url | stylesheet_tag }}

<script src="https://embed.fishook.online/js/widget.js" defer></script>

<script>
  let chatWidgetBaseURL = 'https://embed.fishook.online';

  let shouldForceOpenWidget = false;

  {% if customer %}
    console.log("Customer logged in");

    const checkoutAbandon = "{{ customer.metafields.fishook.checkout_intervention | default: '' }}";
    console.log("checkoutAbandon metafield:", checkoutAbandon);


    if (checkoutAbandon === "true") {
      chatWidgetBaseURL = chatWidgetBaseURL + "/checkout";
      console.log("Setting flag to force widget open");
      shouldForceOpenWidget = true;
    } else {
      console.log("Metafield missing or false");
    }

  {% else %}
    console.log("Customer NOT logged in");
  {% endif %}

  console.log("Final URL:", chatWidgetBaseURL);

  const btn = document.querySelector('.buoy-btn');
  const iframe = document.querySelector('iframe');

  const shop = Shopify.shop;
  let customerId = "{{ customer.id | default: "" }}";
  let cartToken = "{{ cart.token | default: "" }}";

  if (customerId) {

  } else if (cartToken) {
    customerId = cartToken;
  } else {
    customerId = Math.random().toString(36).substring(2, 14);
  }
  const script_tag_id = 'null'; //No longer need to pass it
  const shop_type = 'SHOPIFY';
  const widgetInitUrl = `https://sandbox.fishook.online/oauth/widget/init`;

  async function fishookWidgetInit(){
    try{
      const response = await fetch(widgetInitUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          shop_url: shop,
          shop_type: shop_type,
          guest_id: customerId
        })
      });

      if (!response.ok) {
        throw new Error('Request failed');
      }

      var returnVal = await response.json();
      console.log('returnVal', returnVal);
      return returnVal;
    } catch(err){
      throw Error("Widget initialization failed with error:"+ err)
    }
  }

  function createChatIframe(script_tag_id, shop, shop_type, JWT, CUSTOMER_ID){
    //if(!script_tag_id || !shop || !shop_type || !JWT || !CUSTOMER_ID) return;

    const iframe = document.createElement('iframe');
    iframe.className = 'buoy-chat-frame';
    iframe.id = 'buoy-chat-frame';
    iframe.allow = "microphone; clipboard-write";
    iframe.src = `${chatWidgetBaseURL}?script_tag_id=${script_tag_id}&shop_url=${Shopify.shop}&shop_type=${shop_type}&jwt=${JWT}&customer_id=${CUSTOMER_ID}`;
    document.body.appendChild(iframe);

    iframe.style.opacity = '1';
    iframe.style.transform = 'scale(1)';

    if (shouldForceOpenWidget) {
      iframe.addEventListener('load', function() {
        iframe.contentWindow.postMessage({ type: 'FORCE_OPEN_WIDGET' }, '*');
      });
    }
  }

  btn.addEventListener('click', () => {
    if (iframe.style.opacity === '1') {
      iframe.style.opacity = '0';
      iframe.style.transform = 'scale(0)';
    } else {
      iframe.style.opacity = '1';
      iframe.style.transform = 'scale(1)';
    }
  });

  // Set the src of the iframe to the product URL
  const productUrl = '{{ product.url }}';

  const handleMessage = (event) => {
    if (event.origin !== 'https://reactchatwidget.com') return;
    console.log('Received from iframe:', event.data);

    if (event.data === 'closeChat') {
      iframe.style.opacity = '0';
      iframe.style.transform = 'scale(0)';
    }
  };

  window.addEventListener('message', handleMessage);

  const sendTokenToIframe = () => { iframe.contentWindow.postMessage({ type: 'set-token', payload: 'abc123' }, 'https://reactchatwidget.com'); };
</script>

{% schema %}
{
  "name": "Fishook",
  "target": "body",
  "settings": [ ]
}
{% endschema %}

{% render 'product_tracking' %}


